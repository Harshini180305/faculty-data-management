<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Faculty Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: #f1f8f9;
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    h1, h2, h3, h4 {
      color: #00897b;
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 40px;
    }

    .dashboard-container, .form-container {
      display: none;
    }

    .photo-container {
      width: 150px;
      height: 150px;
      border: 3px solid #00897b;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      margin: 0 auto 20px;
    }

    .photo-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-info {
      text-align: center;
      margin-bottom: 30px;
    }

    .profile-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }

    .profile-section p {
      margin: 12px 0;
      line-height: 1.6;
    }

    .certificate-link {
      color: #00897b;
      text-decoration: none;
      margin-right: 10px;
    }

    .certificate-link:hover {
      text-decoration: underline;
    }

    .actions {
      text-align: center;
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 30px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #004d40;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      font-weight: bold;
      display: block;
      margin-bottom: 8px;
      color: #333;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #bbb;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group input[type="file"] {
      padding: 8px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .conference-entry {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #fff;
    }

    .conference-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .remove-conference {
      color: #f44336;
      cursor: pointer;
      font-size: 14px;
    }

    .remove-conference:hover {
      text-decoration: underline;
    }

    .error-message, .success-message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: none;
      text-align: center;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00897b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    section {
      margin-bottom: 40px;
      padding: 25px;
      border-left: 6px solid #00897b;
      background: #f9f9f9;
      border-radius: 12px;
    }

    section h3 {
      margin-top: 0;
      color: #00695c;
    }

    .photo-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #00897b;
      margin-top: 15px;
    }

    .age-display {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .uppercase-input {
      text-transform: uppercase;
    }

    .back-btn {
      background: #6c757d;
      margin-right: 10px;
    }

    .back-btn:hover {
      background: #5a6268;
    }

    #downloadProfileBtn {
      background: #4caf50;
    }

    #downloadProfileBtn:hover {
      background: #388e3c;
    }

    #formContainer #downloadProfileBtn {
      display: none;
    }

    .exp-research-group {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 20px;
    }

    .exp-research-group .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .exp-research-group .document-upload {
      flex: 1;
      margin-top: 0;
    }

    .exp-research-group textarea {
      min-height: 100px;
    }

    .document-upload {
      margin-top: 15px;
    }

    .upload-preview {
      margin-top: 5px;
      font-size: 0.9em;
      color: #666;
    }

    .upload-preview a {
      color: #00897b;
      text-decoration: none;
    }

    .upload-preview a:hover {
      text-decoration: underline;
    }

    .profile-display-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .profile-display-group {
      margin-bottom: 15px;
    }

    .profile-display-group label {
      font-weight: bold;
      color: #333;
      display: block;
      margin-bottom: 5px;
    }

    .profile-display-group span {
      color: #555;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .form-grid, .profile-display-grid {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .container {
        padding: 15px;
      }

      .exp-research-group {
        flex-direction: column;
      }
    }

    @media print {
      body * {
        visibility: hidden;
      }
      #profileContainer, #profileContainer * {
        visibility: visible;
      }
      #profileContainer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="dashboardContainer" class="dashboard-container">
      <h2><i class="fas fa-user-tie"></i> Faculty Dashboard</h2>
      <div id="welcomeMessage" class="success-message" style="display: none;"></div>
      <div id="messageContainer" class="error-message"></div>
      <div id="profileContainer"></div>
      <div class="actions">
        <button id="editProfileBtn" class="btn" style="background: #00897b;">
          <i class="fas fa-edit"></i> Edit Profile
        </button>
        <button id="downloadProfileBtn" class="btn" style="background: #4caf50;">
          <i class="fas fa-download"></i> Download Profile
        </button>
        <button id="logoutBtn" class="btn" style="background: #f44336;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <div id="formContainer" class="form-container">
      <button id="backToDashboard" class="btn back-btn">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </button>
      <h2><i class="fas fa-user-edit"></i> Faculty Profile Form</h2>
      <div id="formMessageContainer" class="error-message"></div>
      <form id="facultyForm">
        <section>
          <h3><i class="fas fa-image"></i> Profile Photo</h3>
          <div class="form-group">
            <label for="photo">Upload Photo:</label>
            <input type="file" id="photo" name="photo" accept="image/jpeg,image/png" onchange="validateFile(this, 2)">
            <div id="photoPreview" class="photo-preview"></div>
            <span id="photoError" class="error-message" style="display: none;"></span>
          </div>
        </section>

        <section>
          <h3><i class="fas fa-user"></i> Personal Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="name">Full Name*:</label>
              <input type="text" id="name" name="name" maxlength="30" placeholder="Enter full name" required pattern="[A-Za-z ]{2,30}" title="Only alphabets and spaces allowed (2-30 characters)">
            </div>
            <div class="form-group">
              <label for="dob">Date of Birth*:</label>
              <input type="date" id="dob" name="dob" required max="${new Date().toISOString().split('T')[0]}">
              <span id="ageDisplay" class="age-display"></span>
            </div>
            <div class="form-group">
              <label for="email">Email*:</label>
              <input type="email" id="email" name="email" placeholder="Enter email" readonly>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number*:</label>
              <div style="display: flex;">
                <span style="padding: 12px; background: #eee; border: 1px solid #bbb; border-radius: 6px 0 0 6px;">+91</span>
                <input type="tel" id="phone" name="phone" maxlength="10" placeholder="Enter 10-digit phone" style="border-radius: 0 6px 6px 0; flex: 1;" required pattern="[6-9][0-9]{9}" title="10-digit Indian mobile number starting with 6-9">
              </div>
            </div>
            <div class="form-group">
              <label for="gender">Gender*:</label>
              <select id="gender" name="gender" required>
                <option value="">--Select--</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="aadhar">Aadhar Number:</label>
              <input type="text" id="aadhar" name="aadhar" maxlength="12" placeholder="Enter 12-digit Aadhar" pattern="[0-9]{12}" title="12-digit Aadhar number">
            </div>
            <div class="form-group">
              <label for="pan">PAN Number:</label>
              <input type="text" id="pan" name="pan" class="uppercase-input" maxlength="10" placeholder="Enter PAN (e.g., ABCDE1234F)" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" title="Format: ABCDE1234F" oninput="this.value = this.value.toUpperCase()">
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group document-upload">
              <label for="aadharUpload">Upload Aadhar:</label>
              <input type="file" id="aadharUpload" name="aadharUpload" accept=".pdf,.jpg,.jpeg,.png" onchange="validateFile(this, 2)">
              <span id="aadharUploadPreview" class="upload-preview"></span>
              <span id="aadharUploadError" class="error-message" style="display: none;"></span>
            </div>
            <div class="form-group document-upload">
              <label for="panUpload">Upload PAN:</label>
              <input type="file" id="panUpload" name="panUpload" accept=".pdf,.jpg,.jpeg,.png" onchange="validateFile(this, 2)">
              <span id="panUploadPreview" class="upload-preview"></span>
              <span id="panUploadError" class="error-message" style="display: none;"></span>
            </div>
          </div>
        </section>

        <section>
          <h3><i class="fas fa-school"></i> 10th / SSC Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="sscSchool">School Name*:</label>
              <input type="text" id="sscSchool" name="sscSchool" placeholder="Enter school name" maxlength="50" required pattern="[A-Za-z0-9 ,.\-()]{1,50}" title="Alphabets, numbers, spaces, and basic punctuation allowed (max 50 characters)">
            </div>
            <div class="form-group">
              <label for="sscBoard">Board:</label>
              <input type="text" id="sscBoard" name="sscBoard" placeholder="Enter board (e.g., CBSE)" maxlength="50" pattern="[A-Za-z0-9 ,.\-()]{0,50}" title="Alphabets, numbers, spaces, and basic punctuation allowed (max 50 characters)">
            </div>
            <div class="form-group">
              <label for="sscPercent">Percentage:</label>
              <input type="number" id="sscPercent" name="sscPercent" min="0" max="100" step="0.01" placeholder="Enter percentage">
            </div>
            <div class="form-group">
              <label for="sscYear">Year of Passing:</label>
              <input type="number" id="sscYear" name="sscYear" min="1975" max="2025" placeholder="Enter year">
            </div>
          </div>
          <div class="form-group document-upload">
            <label for="sscCertificate">Upload SSC Certificate:</label>
            <input type="file" id="sscCertificate" name="sscCertificate" accept=".pdf,.jpg,.jpeg,.png" onchange="validateFile(this, 2)">
            <span id="sscCertificatePreview" class="upload-preview"></span>
            <span id="sscCertificateError" class="error-message" style="display: none;"></span>
          </div>
        </section>

        <section>
          <h3><i class="fas fa-university"></i> Intermediate Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="interCollege">College Name:</label>
              <input type="text" id="interCollege" name="interCollege" placeholder="Enter college name" maxlength="50" pattern="[A-Za-z0-9 ,.\-()]{0,50}" title="Alphabets, numbers, spaces, and basic punctuation allowed (max 50 characters)">
            </div>
            <div class="form-group">
              <label for="interPercent">Percentage:</label>
              <input type="number" id="interPercent" name="interPercent" min="0" max="100" step="0.01" placeholder="Enter percentage">
            </div>
            <div class="form-group">
              <label for="interYear">Year of Passing:</label>
              <input type="number" id="interYear" name="interYear" min="1975" max="2025" placeholder="Enter year">
            </div>
          </div>
          <div class="form-group document-upload">
            <label for="interCertificate">Upload Intermediate Certificate:</label>
            <input type="file" id="interCertificate" name="interCertificate" accept=".pdf,.jpg,.jpeg,.png" onchange="validateFile(this, 2)">
            <span id="interCertificatePreview" class="upload-preview"></span>
            <span id="interCertificateError" class="error-message" style="display: none;"></span>
          </div>
        </section>

        <section>
          <h3><i class="fas fa-graduation-cap"></i> Degree / B.Tech</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="degCollege">College:</label>
              <input type="text" id="degCollege" name="degCollege" placeholder="Enter college name" maxlength="50" pattern="[A-Za-z0-9 ,.\-()]{0,50}" title="Alphabets, numbers, spaces, and basic punctuation allowed (max 50 characters)">
            </div>
            <div class="form-group">
              <label for="degBranch">Branch:</label>
              <input type="text" id="degBranch" name="degBranch" placeholder="Enter branch (e.g., CSE)" maxlength="50" pattern="[A-Za-z0-9 ,.\-()]{0,50}" title="Alphabets, numbers, spaces, and basic punctuation allowed (max 50 characters)">
            </div>
            <div class="form-group">
              <label for="degCGPA">CGPA:</label>
              <input type="number" id="degCGPA" name="degCGPA" min="0" max="10" step="0.01" placeholder="Enter CGPA">
            </div>
            <div class="form-group">
              <label for="degYear">Year of Passing:</label>
              <input type="number" id="degYear" name="degYear" min="1975" max="2025" placeholder="Enter year">
            </div>
          </div>
          <div class="form-group document-upload">
            <label for="degCertificate">Upload Degree Certificate:</label>
            <input type="file" id="degCertificate" name="degCertificate" accept=".pdf,.jpg,.jpeg,.png" onchange="validateFile(this, 2)">
            <span id="degCertificatePreview" class="upload-preview"></span>
            <span id="degCertificateError" class="error-message" style="display: none;"></span>
          </div>
        </section>

        <section>
          <h3><i class="fas fa-user-tie"></i> Ph.D. Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="phdStatus">Status:</label>
              <select id="phdStatus" name="phdStatus">
                <option value="">--Select--</option>
                <option value="Completed">Completed</option>
                <option value="Pursuing">Pursuing</option>
              </select>
            </div>
            <div class="form-group" id="phdDetailsBox" style="display: none;">
              <label for="phdDetails">PhD Details (Topic, Guide, Univ, Start Year):</label>
              <textarea id="phdDetails" name="phdDetails" rows="4" placeholder="Enter PhD details" maxlength="500"></textarea>
            </div>
          </div>
        </section>

        <section id="conferencesSection">
          <h3><i class="fas fa-users"></i> Conferences</h3>
          <div id="conferenceEntries"></div>
          <button type="button" class="btn" style="background: #5c6bc0; margin-top: 15px;" onclick="addConference()">
            <i class="fas fa-plus"></i> Add Conference
          </button>
        </section>

        <section>
          <h3><i class="fas fa-briefcase"></i> Experience & Research</h3>
          <div class="form-group">
            <label for="experience">Total Experience (Years):</label>
            <input type="number" id="experience" name="experience" min="0" max="50" step="0.1" placeholder="Enter years">
          </div>
          <div class="exp-research-group">
            <div class="form-group">
              <label for="awards">Awards (Comma-separated):</label>
              <textarea id="awards" name="awards" rows="4" placeholder="e.g., Best Teacher, Innovator Award" maxlength="500"></textarea>
            </div>
            <div class="form-group">
              <label for="awardYears">Award Years (Comma-separated):</label>
              <textarea id="awardYears" name="awardYears" rows="4" placeholder="e.g., 2020, 2021" maxlength="100"></textarea>
            </div>
          </div>
          <div class="exp-research-group">
            <div class="form-group document-upload">
              <label for="awardsUpload">Upload Award Certificates:</label>
              <input type="file" id="awardsUpload" name="awardsUpload" accept=".pdf,.jpg,.jpeg,.png" multiple onchange="validateMultipleFiles(this, 10, 2)">
              <span id="awardsUploadPreview" class="upload-preview"></span>
              <span id="awardsUploadError" class="error-message" style="display: none;"></span>
            </div>
          </div>
          <div class="exp-research-group">
            <div class="form-group">
              <label for="certs">Certifications (Comma-separated):</label>
              <textarea id="certs" name="certs" rows="4" placeholder="e.g., AWS Certified Developer, PMP, Data Science" maxlength="500"></textarea>
            </div>
            <div class="form-group">
              <label for="certYears">Certification Years (Comma-separated):</label>
              <textarea id="certYears" name="certYears" rows="4" placeholder="e.g., 2020, 2021, 2022" maxlength="100"></textarea>
            </div>
          </div>
          <div class="exp-research-group">
            <div class="form-group document-upload">
              <label for="certsUpload">Upload Certification Documents:</label>
              <input type="file" id="certsUpload" name="certsUpload" accept=".pdf,.jpg,.jpeg,.png" multiple onchange="validateMultipleFiles(this, 10, 2)">
              <span id="certsUploadPreview" class="upload-preview"></span>
              <span id="certsUploadError" class="error-message" style="display: none;"></span>
            </div>
          </div>
          <div class="exp-research-group">
            <div class="form-group">
              <label for="research">Research Paper Descriptions:</label>
              <textarea id="research" name="research" rows="4" placeholder="Describe research papers" maxlength="1000"></textarea>
            </div>
            <div class="form-group document-upload">
              <label for="researchPapers">Upload Research Papers:</label>
              <input type="file" id="researchPapers" name="researchPapers" accept=".pdf,.jpg,.jpeg,.png" multiple onchange="validateMultipleFiles(this, 10, 2)">
              <span id="researchPapersPreview" class="upload-preview"></span>
              <span id="researchPapersError" class="error-message" style="display: none;"></span>
            </div>
          </div>
        </section>

        <div class="actions">
          <button type="submit" class="btn" style="background: #00897b;">
            Submit Profile
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <script>
    let conferenceCount = 0;
    let facultyEmail = '';

    const dashboardContainer = document.getElementById('dashboardContainer');
    const formContainer = document.getElementById('formContainer');
    const profileContainer = document.getElementById('profileContainer');
    const messageContainer = document.getElementById('messageContainer');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const formMessageContainer = document.getElementById('formMessageContainer');
    const facultyForm = document.getElementById('facultyForm');
    const photoInput = document.getElementById('photo');
    const photoPreview = document.getElementById('photoPreview');
    const dobInput = document.getElementById('dob');
    const ageDisplay = document.getElementById('ageDisplay');
    const phdStatusSelect = document.getElementById('phdStatus');
    const phdDetailsBox = document.getElementById('phdDetailsBox');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const backToDashboard = document.getElementById('backToDashboard');
    const downloadProfileBtn = document.getElementById('downloadProfileBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Page loaded, initializing dashboard');
      facultyEmail = localStorage.getItem('userEmail');
      const userRole = localStorage.getItem('userRole');
      
      if (userRole !== 'faculty' || !facultyEmail) {
        console.log('Invalid user, redirecting to login');
        alert('Please login as Faculty');
        window.location.href = 'sampleloginfaculty.html';
        return;
      }

      console.log('User authenticated:', { facultyEmail });

      loadingOverlay.style.display = 'flex';

      try {
        const response = await fetch(`http://localhost:5000/api/faculty/${facultyEmail}`);
        if (!response.ok) {
          throw new Error(`Failed to fetch profile: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();

        if (data.exists) {
          await loadProfile();
          showMessage(welcomeMessage, `Welcome back, ${data.profile.name || facultyEmail}!`, 'success');
        } else {
          showMessage(messageContainer, 'No profile found. Please complete your profile.', 'error');
          showProfileForm();
        }
      } catch (error) {
        console.error('Error checking profile existence:', error);
        showMessage(messageContainer, `Error checking profile status: ${error.message}. Please try again.`, 'error');
        showProfileForm();
      } finally {
        loadingOverlay.style.display = 'none';
      }
    });

    editProfileBtn.addEventListener('click', showProfileForm);
    downloadProfileBtn.addEventListener('click', downloadProfileAsPDF);
    logoutBtn.addEventListener('click', logout);
    backToDashboard.addEventListener('click', () => {
      console.log('Back to Dashboard button clicked');
      showDashboard();
    });
    photoInput.addEventListener('change', handlePhotoUpload);
    dobInput.addEventListener('change', calculateAge);
    phdStatusSelect.addEventListener('change', togglePhD);
    facultyForm.addEventListener('submit', handleFormSubmit);

    async function loadProfile() {
      console.log('Loading profile for:', facultyEmail);
      try {
        const response = await fetch(`http://localhost:5000/api/faculty/${facultyEmail}`);
        console.log('Profile fetch status:', response.status);

        if (!response.ok) {
          throw new Error(`Failed to fetch profile: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Profile data received:', data);
        
        if (data.exists) {
          displayProfile(data.profile);
          showMessage(messageContainer, 'Profile loaded successfully', 'success');
          dashboardContainer.style.display = 'block';
          formContainer.style.display = 'none';
        } else {
          showMessage(messageContainer, 'No profile found. Please complete your profile.', 'error');
          showProfileForm();
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        showMessage(messageContainer, `Error loading profile: ${error.message}. Please try again.`, 'error');
        dashboardContainer.style.display = 'block';
        formContainer.style.display = 'none';
      }
    }

    async function showDashboard() {
      console.log('Switching to dashboard view');
      try {
        messageContainer.style.display = 'none';
        welcomeMessage.style.display = 'none';
        
        formContainer.style.display = 'none';
        dashboardContainer.style.display = 'block';
        
        loadingOverlay.style.display = 'flex';
        const response = await fetch(`http://localhost:5000/api/faculty/${facultyEmail}`);
        if (!response.ok) {
          throw new Error(`Failed to fetch profile: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        
        if (data.exists) {
          displayProfile(data.profile);
          showMessage(messageContainer, 'Profile loaded successfully', 'success');
        } else {
          showMessage(messageContainer, 'No profile found. Please complete your profile.', 'error');
          profileContainer.innerHTML = '';
        }
      } catch (error) {
        console.error('Error switching to dashboard:', error);
        showMessage(messageContainer, `Error loading dashboard: ${error.message}. Please try again.`, 'error');
        profileContainer.innerHTML = '';
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    function showProfileForm() {
      console.log('Switching to form view');
      try {
        formMessageContainer.style.display = 'none';
        
        dashboardContainer.style.display = 'none';
        formContainer.style.display = 'block';
        
        const emailField = document.getElementById('email');
        if (emailField) {
          emailField.value = facultyEmail;
        }
        loadProfileData(facultyEmail);
      } catch (error) {
        console.error('Error switching to form view:', error);
        showMessage(formMessageContainer, `Error loading form: ${error.message}. Please try again.`, 'error');
      }
    }

    function displayProfile(profile) {
      console.log('Rendering profile:', profile);
      try {
        const dob = profile.dob ? new Date(profile.dob).toLocaleDateString('en-GB') : 'Not provided';
        const awardsList = profile.awards ? profile.awards.split(',').map(t => t.trim()).filter(t => t) : [];
        const awardYearsList = profile.awardYears || Array(awardsList.length).fill('Not specified');
        const certsList = profile.certs ? profile.certs.split(',').map(t => t.trim()).filter(t => t) : [];
        const certYearsList = profile.certYears || Array(certsList.length).fill('Not specified');

        profileContainer.innerHTML = `
          <div class="profile-info" style="width: 100%;">
            ${profile.photoPath ? 
              `<div class="photo-container">
                <img src="http://localhost:5000/${profile.photoPath}" onerror="this.src='https://via.placeholder.com/150'; console.error('Failed to load image: ${profile.photoPath}');">
              </div>` : 
              `<div class="photo-container" style="background: #eee; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-user" style="font-size: 50px; color: #aaa;"></i>
              </div>`}
            <h2>${profile.name || 'Not provided'}</h2>
            <p>${profile.email || 'Not provided'}</p>
            <p>Department: ${profile.department || 'Not provided'}</p>
          </div>

          <section>
            <h3><i class="fas fa-user"></i> Personal Information</h3>
            <div class="profile-display-grid">
              <div class="profile-display-group">
                <label>Full Name:</label>
                <span>${profile.name || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Date of Birth:</label>
                <span>${dob}</span>
              </div>
              <div class="profile-display-group">
                <label>Email:</label>
                <span>${profile.email || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Phone Number:</label>
                <span>${profile.phone ? `+91 ${profile.phone}` : 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Gender:</label>
                <span>${profile.gender || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Aadhar Number:</label>
                <span>${profile.aadhar || 'Not provided'}</span>
                ${profile.aadharPath ? `<br><a href="http://localhost:5000/${profile.aadharPath}" class="certificate-link" download>Download Aadhar</a>` : ''}
              </div>
              <div class="profile-display-group">
                <label>PAN Number:</label>
                <span>${profile.pan || 'Not provided'}</span>
                ${profile.panPath ? `<br><a href="http://localhost:5000/${profile.panPath}" class="certificate-link" download>Download PAN</a>` : ''}
              </div>
            </div>
          </section>

          <section>
            <h3><i class="fas fa-school"></i> 10th / SSC Details</h3>
            <div class="profile-display-grid">
              <div class="profile-display-group">
                <label>School Name:</label>
                <span>${profile.sscSchool || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Board:</label>
                <span>${profile.sscBoard || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Percentage:</label>
                <span>${profile.sscPercent != null ? `${profile.sscPercent}%` : 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Year of Passing:</label>
                <span>${profile.sscYear || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>SSC Certificate:</label>
                <span>${profile.sscCertPath ? `<a href="http://localhost:5000/${profile.sscCertPath}" class="certificate-link" download>Download SSC Certificate</a>` : 'Not uploaded'}</span>
              </div>
            </div>
          </section>

          <section>
            <h3><i class="fas fa-university"></i> Intermediate Details</h3>
            <div class="profile-display-grid">
              <div class="profile-display-group">
                <label>College Name:</label>
                <span>${profile.interCollege || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Percentage:</label>
                <span>${profile.interPercent != null ? `${profile.interPercent}%` : 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Year of Passing:</label>
                <span>${profile.interYear || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Intermediate Certificate:</label>
                <span>${profile.interCertPath ? `<a href="http://localhost:5000/${profile.interCertPath}" class="certificate-link" download>Download Intermediate Certificate</a>` : 'Not uploaded'}</span>
              </div>
            </div>
          </section>

          <section>
            <h3><i class="fas fa-graduation-cap"></i> Degree / B.Tech</h3>
            <div class="profile-display-grid">
              <div class="profile-display-group">
                <label>College:</label>
                <span>${profile.degCollege || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Branch:</label>
                <span>${profile.degBranch || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>CGPA:</label>
                <span>${profile.degCGPA != null ? profile.degCGPA : 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Year of Passing:</label>
                <span>${profile.degYear || 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Degree Certificate:</label>
                <span>${profile.degCertPath ? `<a href="http://localhost:5000/${profile.degCertPath}" class="certificate-link" download>Download Degree Certificate</a>` : 'Not uploaded'}</span>
              </div>
            </div>
          </section>

          <section>
            <h3><i class="fas fa-user-tie"></i> Ph.D. Details</h3>
            <div class="profile-display-grid">
              <div class="profile-display-group">
                <label>Status:</label>
                <span>${profile.phdStatus || 'Not provided'}</span>
              </div>
              ${profile.phdStatus === 'Completed' || profile.phdStatus === 'Pursuing' ? `
              <div class="profile-display-group">
                <label>PhD Details (Topic, Guide, Univ, Start Year):</label>
                <span>${profile.phdDetails || 'Not provided'}</span>
              </div>` : ''}
            </div>
          </section>

          ${profile.conferences && profile.conferences.length > 0 ? `
          <section>
            <h3><i class="fas fa-users"></i> Conferences</h3>
            ${profile.conferences.map((conf, index) => `
              <div class="conference-entry">
                <h4>Conference ${index + 1}</h4>
                <div class="profile-display-grid">
                  <div class="profile-display-group">
                    <label>Name:</label>
                    <span>${conf.name || 'Not provided'}</span>
                  </div>
                  <div class="profile-display-group">
                    <label>Organized By:</label>
                    <span>${conf.organizedBy || 'Not provided'}</span>
                  </div>
                  <div class="profile-display-group">
                    <label>ISBN:</label>
                    <span>${conf.isbn || 'Not provided'}</span>
                  </div>
                  <div class="profile-display-group">
                    <label>Certificate:</label>
                    <span>${profile.conferenceCerts && profile.conferenceCerts[index] ? `<a href="http://localhost:5000/${profile.conferenceCerts[index]}" class="certificate-link" download>Download Certificate</a>` : 'Not uploaded'}</span>
                  </div>
                </div>
              </div>
            `).join('')}
          </section>` : `
          <section>
            <h3><i class="fas fa-users"></i> Conferences</h3>
            <p>None</p>
          </section>`}

          <section>
            <h3><i class="fas fa-briefcase"></i> Experience & Research</h3>
            <div class="profile-display-grid">
              <div class="profile-display-group">
                <label>Total Experience (Years):</label>
                <span>${profile.experience != null ? `${profile.experience} years` : 'Not provided'}</span>
              </div>
              <div class="profile-display-group">
                <label>Awards:</label>
                <span>${awardsList.length > 0 ? awardsList.map((award, i) => `${award} (${awardYearsList[i]})`).join(', ') : 'None'}</span>
                ${profile.awardsCertPaths && profile.awardsCertPaths.length > 0 ? `
                  <br>${profile.awardsCertPaths.map((path, index) => `<a href="http://localhost:5000/${path}" class="certificate-link" download>Download Award ${index + 1}</a>`).join(' ')}
                ` : ''}
              </div>
              <div class="profile-display-group">
                <label>Certifications:</label>
                <span>${certsList.length > 0 ? certsList.map((cert, i) => `${cert} (${certYearsList[i]})`).join(', ') : 'None'}</span>
                ${profile.certsPaths && profile.certsPaths.length > 0 ? `
                  <br>${profile.certsPaths.map((path, index) => `<a href="http://localhost:5000/${path}" class="certificate-link" download>Download Certification ${index + 1}</a>`).join(' ')}
                ` : ''}
              </div>
              <div class="profile-display-group">
                <label>Research Paper Descriptions:</label>
                <span>${profile.research || 'None'}</span>
                ${profile.researchPapers && profile.researchPapers.length > 0 ? `
                  <br>${profile.researchPapers.map((path, index) => `<a href="http://localhost:5000/${path}" class="certificate-link" download>Download Paper ${index + 1}</a>`).join(' ')}
                ` : ''}
              </div>
            </div>
          </section>
        `;
      } catch (error) {
        console.error('Error rendering profile:', error);
        showMessage(messageContainer, `Error rendering profile: ${error.message}. Please try again.`, 'error');
      }
    }

    async function loadProfileData(email) {
      console.log('Loading profile data for form:', email);
      try {
        const response = await fetch(`http://localhost:5000/api/faculty/${email}`);
        console.log('Profile data fetch status:', response.status);
        if (!response.ok) {
          throw new Error(`Failed to fetch profile: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        console.log('Profile data for form:', data);
        
        conferenceCount = 0;
        document.getElementById('conferenceEntries').innerHTML = '';
        
        if (data.exists) {
          populateForm(data.profile);
        } else {
          facultyForm.reset();
          document.getElementById('email').value = facultyEmail;
          photoPreview.innerHTML = '';
          document.getElementById('aadharUploadPreview').innerHTML = '';
          document.getElementById('panUploadPreview').innerHTML = '';
          document.getElementById('sscCertificatePreview').innerHTML = '';
          document.getElementById('interCertificatePreview').innerHTML = '';
          document.getElementById('degCertificatePreview').innerHTML = '';
          document.getElementById('awardsUploadPreview').innerHTML = '';
          document.getElementById('certsUploadPreview').innerHTML = '';
          document.getElementById('researchPapersPreview').innerHTML = '';
        }
      } catch (error) {
        console.error('Error loading profile data:', error);
        showMessage(formMessageContainer, `Error loading profile: ${error.message}. Please try again.`, 'error');
      }
    }

    function populateForm(profile) {
      console.log('Populating form with profile:', profile);
      
      document.getElementById('name').value = profile.name || '';
      document.getElementById('dob').value = profile.dob ? new Date(profile.dob).toISOString().split('T')[0] : '';
      document.getElementById('phone').value = profile.phone || '';
      document.getElementById('gender').value = profile.gender || '';
      document.getElementById('aadhar').value = profile.aadhar || '';
      document.getElementById('pan').value = profile.pan || '';
      document.getElementById('sscSchool').value = profile.sscSchool || '';
      document.getElementById('sscBoard').value = profile.sscBoard || '';
      document.getElementById('sscPercent').value = profile.sscPercent != null ? profile.sscPercent : '';
      document.getElementById('sscYear').value = profile.sscYear || '';
      document.getElementById('interCollege').value = profile.interCollege || '';
      document.getElementById('interPercent').value = profile.interPercent != null ? profile.interPercent : '';
      document.getElementById('interYear').value = profile.interYear || '';
      document.getElementById('degCollege').value = profile.degCollege || '';
      document.getElementById('degBranch').value = profile.degBranch || '';
      document.getElementById('degCGPA').value = profile.degCGPA != null ? profile.degCGPA : '';
      document.getElementById('degYear').value = profile.degYear || '';
      document.getElementById('phdStatus').value = profile.phdStatus || '';
      document.getElementById('phdDetails').value = profile.phdDetails || '';
      document.getElementById('experience').value = profile.experience != null ? profile.experience : '';
      document.getElementById('awards').value = profile.awards || '';
      document.getElementById('awardYears').value = profile.awardYears ? profile.awardYears.join(', ') : '';
      document.getElementById('certs').value = profile.certs || '';
      document.getElementById('certYears').value = profile.certYears ? profile.certYears.join(', ') : '';
      document.getElementById('research').value = profile.research || '';

      calculateAge();
      togglePhD();

      if (profile.photoPath) {
        const img = document.createElement('img');
        img.src = `http://localhost:5000/${profile.photoPath}`;
        img.onerror = () => {
          console.error('Failed to load profile photo:', profile.photoPath);
          photoPreview.innerHTML = '';
        };
        photoPreview.innerHTML = '';
        photoPreview.appendChild(img);
      }

      document.getElementById('aadharUploadPreview').innerHTML = profile.aadharPath ? 
        `<a href="http://localhost:5000/${profile.aadharPath}" download>View Aadhar</a>` : '';
      document.getElementById('panUploadPreview').innerHTML = profile.panPath ? 
        `<a href="http://localhost:5000/${profile.panPath}" download>View PAN</a>` : '';
      document.getElementById('sscCertificatePreview').innerHTML = profile.sscCertPath ? 
        `<a href="http://localhost:5000/${profile.sscCertPath}" download>View SSC Certificate</a>` : '';
      document.getElementById('interCertificatePreview').innerHTML = profile.interCertPath ? 
        `<a href="http://localhost:5000/${profile.interCertPath}" download>View Intermediate Certificate</a>` : '';
      document.getElementById('degCertificatePreview').innerHTML = profile.degCertPath ? 
        `<a href="http://localhost:5000/${profile.degCertPath}" download>View Degree Certificate</a>` : '';
      document.getElementById('awardsUploadPreview').innerHTML = profile.awardsCertPaths && profile.awardsCertPaths.length > 0 ? 
        profile.awardsCertPaths.map((path, index) => `<a href="http://localhost:5000/${path}" download>View Award ${index + 1}</a>`).join(' ') : '';
      document.getElementById('certsUploadPreview').innerHTML = profile.certsPaths && profile.certsPaths.length > 0 ? 
        profile.certsPaths.map((path, index) => `<a href="http://localhost:5000/${path}" download>View Certification ${index + 1}</a>`).join(' ') : '';
      document.getElementById('researchPapersPreview').innerHTML = profile.researchPapers && profile.researchPapers.length > 0 ? 
        profile.researchPapers.map((path, index) => `<a href="http://localhost:5000/${path}" download>View Paper ${index + 1}</a>`).join(' ') : '';

      if (profile.conferences && profile.conferences.length > 0) {
        profile.conferences.forEach((conf, index) => {
          addConference(conf);
          const certPreview = document.getElementById(`confCertPreview${conferenceCount}`);
          if (profile.conferenceCerts && profile.conferenceCerts[index]) {
            certPreview.innerHTML = `<a href="http://localhost:5000/${profile.conferenceCerts[index]}" download>View Certificate</a>`;
          }
        });
      }
    }

    function showMessage(container, message, type = 'error') {
      container.innerHTML = message;
      container.className = type === 'success' ? 'success-message' : 'error-message';
      container.style.display = 'block';
      setTimeout(() => {
        container.style.display = 'none';
      }, 7000);
    }

    function validateFile(input, maxSizeMB) {
      const errorDiv = document.getElementById(`${input.id}Error`);
      errorDiv.style.display = 'none';
      
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const maxSize = maxSizeMB * 1024 * 1024;
        const allowedTypes = input.accept.split(',').map(t => t.trim().toLowerCase());
        const fileType = file.mimetype || file.type;

        if (!allowedTypes.includes(fileType.toLowerCase()) && !allowedTypes.some(type => file.name.toLowerCase().endsWith(type.replace('.', '')))) {
          errorDiv.textContent = `Invalid file type. Allowed: ${allowedTypes.join(', ')}`;
          errorDiv.style.display = 'block';
          input.value = '';
          return false;
        }
        if (file.size > maxSize) {
          errorDiv.textContent = `File size exceeds ${maxSizeMB}MB limit`;
          errorDiv.style.display = 'block';
          input.value = '';
          return false;
        }
        return true;
      }
      return true;
    }

    function validateMultipleFiles(input, maxCount, maxSizeMB) {
      const errorDiv = document.getElementById(`${input.id}Error`);
      errorDiv.style.display = 'none';
      
      if (input.files && input.files.length > 0) {
        const files = Array.from(input.files);
        const maxCount = input.getAttribute('data-max-files') || maxCount;
        const maxSize = maxSizeMB * 1024 * 1024;
        const allowedTypes = input.accept.split(',').map(t => t.trim().toLowerCase());

        if (files.length > maxCount) {
          errorDiv.textContent = `Maximum ${maxCount} files allowed`;
          errorDiv.style.display = 'block';
          input.value = [];
          return false;
        }

        for (let file of files) {
          const fileType = file.mimetype || 'file.type';
          if (!allowedTypes.includes(fileType.toLowerCase()) && !allowedTypes.some(type => file.name.toLowerCase().endsWith(type.replace('.', '')))) {
            errorDiv.textContent = `Invalid file type: ${file.name}. Allowed: ${allowedTypes.join(', ')}`;
            errorDiv.style.display = 'block';
            input.value = '';
            return false;
          }
          if (file.size > maxSize) {
            errorDiv.textContent = `File '${file.name}' exceeds ${maxSizeMB}MB limit`;
            errorDiv.style.display = 'block';
            input.value = '';
            return false;
          }
        }
        return true;
      }
      return true;
    }

    function handlePhotoUpload() {
      if (!validateFile(photoInput, 2)) {
        photoPreview.innerHTML = '';
        return;
      }
      
      const file = photoInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          photoPreview.innerHTML = `<img src="${reader.result}" alt="Profile Photo Preview">`;
        };
        reader.onerror = () => {
          console.error('Error reading photo file');
          photoPreview.innerHTML = '';
          showMessage(formMessageContainer, 'Error reading photo file', 'error');
        };
        reader.readAsDataURL(file);
      } else {
        photoPreview.innerHTML = '';
      }
    }

    function calculateAge() {
      const dob = new Date(dobInput.value);
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const m = today.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
        age--;
      }
      ageDisplay.textContent = dobInput.value && !isNaN(dob) ? `Age: ${age}` : '';
    }

    function togglePhD() {
      const phdStatus = phdStatusSelect.value;
      phdDetailsBox.style.display = (phdStatus === 'Completed' || phdStatus === 'Pursuing') ? 'block' : 'none';
      if (phdStatus === '') {
        document.getElementById('phdDetails').value = '';
      }
    }

    function addConference(conf = {}) {
      console.log('Adding conference entry:', conf);
      conferenceCount++;
      const conferenceEntries = document.getElementById('conferenceEntries');
      const entry = document.createElement('div');
      entry.className = 'conference-entry';
      entry.id = `conference-${conferenceCount}`;
      entry.innerHTML = `
        <div class="conference-header">
          <h4>Conference ${conferenceCount}</h4>
          <span class="remove-conference" onclick="removeConference(${conferenceCount})">
            <i class="fas fa-trash"></i> Remove
          </span>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="confName${conferenceCount}">Name*:</label>
            <input type="text" id="confName${conferenceCount}" name="confName${conferenceCount}" placeholder="Enter conference name" value="${conf.name || ''}" required maxlength="100">
          </div>
          <div class="form-group">
            <label for="confOrg${conferenceCount}">Organized By*:</label>
            <input type="text" id="confOrg${conferenceCount}" name="confOrg${conferenceCount}" placeholder="Enter organizer" value="${conf.organizedBy || ''}" required maxlength="100">
          </div>
          <div class="form-group">
            <label for="confIsbn${conferenceCount}">ISBN*:</label>
            <input type="text" id="confIsbn${conferenceCount}" name="confIsbn${conferenceCount}" placeholder="Enter ISBN" value="${conf.isbn || ''}" required maxlength="20">
          </div>
        </div>
        </working class="form-group document-upload">
          <label for="confCert${conferenceCount}">Upload Certificate:</label>
          <input type="file" id="confCert${conferenceCount}" name="conferenceCertificates" accept=".pdf,.jpg,.jpeg,.png" onchange="validateFile(this, 2)">
          <span id="confCertPreview${conferenceCount}" class="upload-preview"></span>
          <span id="confCert${conferenceCount}Error" class="error-message" style="display: none;"></span>
        </div>
      `;
      conferenceEntries.appendChild(entry);
    }

    function removeConference(id) {
      const entry = document.getElementById(`conference-${id}`);
      if (entry) {
        entry.remove();
        console.log(`Removed conference entry: conference-${id}`);
      }
    }

    async function handleFormSubmit(event) {
      event.preventDefault();
      console.log('Form submitted, processing data');
      loadingOverlay.style.display = 'flex';

      try {
        const formData = new FormData(facultyForm);
        
        // Validate awards and certifications
        const awards = formData.get('awards') ? formData.get('awards').split(',').map(t => t.trim()).filter(t => t.length) : [];
        const awardYears = formData.get('awardYears') ? formData.get('awardYears').split(',').map(t => t.trim()).filter(t => t.match(/^\d{4}$/)).map(Number) : [];
        const certifications = formData.get('certs') ? formData.get('certs').split(',').map(t => t.trim()).filter(t => t.length) : [];
        const certYears = formData.get('certYears') ? formData.get('certYears').split(',').map(t => t.trim()).filter(t => t.match(/^\d{4}$/)).map(Number) : [];
        
        if (awardYears.length > awards.length) {
          throw new Error(`Number of award years (${awardYears.length}) cannot exceed number of awards (${awards.length})`);
        }
        if (certYears.length > certifications.length) {
          throw new Error(`Number of certification years (${certYears.length}) cannot exceed number of certifications (${certifications.length})`);
        }

        const awardsFiles = formData.getAll('awardsUpload');
        const certsFiles = formData.getAll('certsUpload');
        if (awardsFiles.length > awards.length) {
          throw new Error(`Number of award files (${awardsFiles.length}) cannot exceed number of awards (${awards.length})`);
        }
        if (certsFiles.length > certifications.length) {
          throw new Error(`Number of certification files (${certsFiles.length}) cannot exceed number of certifications (${certifications.length})`);
        }

        // Collect conference data
        const conferences = [];
        for (let i = 1; i <= conferenceCount; i++) {
          if (document.getElementById(`conference-${i}`)) {
            const name = document.getElementById(`confName${i}`).value.trim();
            const organizedBy = document.getElementById(`confOrg${i}`).value.trim();
            const isbn = document.getElementById(`confIsbn${i}`).value.trim();
            if (name && organizedBy && isbn) {
              conferences.push({ name, organizedBy, isbn });
            }
          }
        }
        formData.set('conferences', JSON.stringify(conferences));

        // Validate required fields
        const requiredFields = ['name', 'dob', 'phone', 'gender', 'sscSchool'];
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            throw new Error(`Required field "${field}" is missing`);
          }
        }

        const aadhar = formData.get('aadhar');
        if (aadhar && !/^\d{12}$/.test(aadhar)) {
          throw new Error('Aadhar must be a 12-digit number');
        }

        const pan = formData.get('pan');
        if (pan && !/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(pan)) {
          throw new Error('Invalid PAN format. Expected: ABCDE1234F');
        }

        // Validate numeric fields
        const numericFields = [
          { id: 'sscPercent', min: 0, max: 100, name: 'SSC Percentage' },
          { id: 'interPercent', min: 0, max: 100, name: 'Intermediate Percentage' },
          { id: 'degCGPA', min: 0, max: 10, name: 'Degree CGPA' },
          { id: 'sscYear', min: 1975, max: 2025, name: 'SSC Year' },
          { id: 'interYear', min: 1975, max: 2025, name: 'Intermediate Year' },
          { id: 'degYear', min: 1975, max: 2025, name: 'Degree Year' },
          { id: 'experience', min: 0, max: 50, name: 'Experience' }
        ];
        for (const field of numericFields) {
          const value = formData.get(field.id);
          if (value && (isNaN(value) || value < field.min || value > field.max)) {
            throw new Error(`${field.name} must be between ${field.min} and ${field.max}`);
          }
        }

        console.log('Submitting form data to server');
        const response = await fetch('http://localhost:5000/api/faculty', {
          method: 'POST',
          body: formData
        });

        console.log('Server response status:', response.status);
        const data = await response.json();
        console.log('Server response data:', data);

        if (!response.ok) {
          const errorDetails = data.details || data.error || 'Unknown error';
          const suggestion = data.suggestion || 'Please check the form and try again.';
          throw new Error(`${errorDetails}. ${suggestion}`);
        }

        showMessage(formMessageContainer, data.message || 'Profile saved successfully', 'success');
        
        if (data.exists && data.profile) {
          console.log('Rendering profile from POST response:', data.profile);
          displayProfile(data.profile);
          dashboardContainer.style.display = 'block';
          formContainer.style.display = 'none';
        } else {
          console.warn('No profile data in response, fetching updated profile');
          const profileResponse = await fetch(`http://localhost:5000/api/faculty/${facultyEmail}`);
          if (!profileResponse.ok) {
            throw new Error(`Failed to fetch updated profile: ${profileResponse.status} ${profileResponse.statusText}`);
          }
          const profileData = await profileResponse.json();
          if (profileData.exists && profileData.profile) {
            console.log('Rendering profile from GET request:', profileData.profile);
            displayProfile(profileData.profile);
            dashboardContainer.style.display = 'block';
            formContainer.style.display = 'none';
          } else {
            throw new Error('Could not fetch updated profile data');
          }
        }

      } catch (error) {
        console.error('Error submitting form:', error);
        showMessage(formMessageContainer, `Error: ${error.message}`, 'error');
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    async function downloadProfileAsPDF() {
      console.log('Initiating profile download as PDF');
      loadingOverlay.style.display = 'flex';

      try {
        const element = profileContainer;
        const opt = {
          margin: 0.5,
          filename: `Faculty_Profile_${facultyEmail.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        await html2pdf().from(element).set(opt).save();
        console.log('PDF generated and downloaded');
        showMessage(messageContainer, 'Profile downloaded successfully', 'success');
      } catch (error) {
        console.error('Error downloading profile:', error);
        showMessage(messageContainer, `Error downloading profile: ${error.message}. Please try again.`, 'error');
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    function logout() {
      console.log('Logging out user:', facultyEmail);
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userRole');
      window.location.href = 'sampleloginfaculty.html';
    }
  </script>
</body>
</html>